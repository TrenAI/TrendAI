<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TrendAI - Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap"
      rel="stylesheet"
    />
    <style>
      .codex-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        backdrop-filter: blur(6px);
        background-color: rgba(0, 0, 0, 0.4);
        z-index: 999;
      }

      .codex-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        width: 860px;
        max-width: 95vw;
        background-color: #121212;
        border-radius: 16px;
        box-shadow: 0 0 40px rgba(0, 255, 204, 0.5);
        z-index: 1000;
        display: flex;
        flex-direction: row;
        overflow: hidden;
        transition: transform 0.3s ease, opacity 0.3s ease;
        opacity: 0;
      }

      .codex-popup.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }

      .codex-left {
        background-color: #111;
        padding: 20px;
        width: 180px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        border-right: 1px solid #00ffcc;
      }

      .codex-left button,
      .codex-right button {
        background: none;
        border: none;
        color: #00ffcc;
        padding: 10px;
        text-align: left;
        cursor: pointer;
        font-size: 0.95em;
        border-radius: 6px;
        transition: background-color 0.3s, transform 0.2s;
      }

      .codex-left button:hover,
      .codex-right button:hover {
        background-color: #00ffcc33;
        transform: scale(1.03);
      }
      .codex-right select {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #00ffcc;
        background-color: #1e1e1e;
        color: #00ffcc;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .codex-right select:focus {
        border-color: #00ffee;
        box-shadow: 0 0 8px rgba(0, 255, 204, 0.5);
        outline: none;
      }

      .codex-right label {
        margin-bottom: 6px;
        display: inline-block;
      }

      .codex-right input[type="radio"] {
        margin-right: 6px;
      }

      .codex-right {
        padding: 20px;
        flex-grow: 1;
        color: #e0e0e0;
        font-size: 0.95em;
      }

      /* --- Enhanced Preferences Section Styles --- */
      .codex-right .preference-group {
        margin-bottom: 24px;
      }

      .codex-right .preference-group label {
        font-weight: bold;
        color: #00ffcc;
        display: block;
        margin-bottom: 6px;
      }

      .codex-right select {
        transition: all 0.3s ease;
      }

      .codex-right select:hover {
        transform: scale(1.02);
        box-shadow: 0 0 6px rgba(0, 255, 204, 0.4);
      }

      .codex-right input[type="radio"] {
        accent-color: #00ffcc;
        margin-right: 6px;
      }

      .codex-right .theme-options {
        margin-top: 12px;
      }

      .codex-right .theme-options label {
        display: inline-block;
        margin-right: 20px;
      }

      .codex-close {
        position: absolute;
        top: 8px;
        right: 14px;
        font-size: 1.2em;
        color: #888;
        cursor: pointer;
      }

      .codex-close:hover {
        color: #fff;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        background-color: #0b0b0b;
        color: #e0e0e0;
        font-family: "Orbitron", sans-serif;
        overflow-x: hidden;
      }

      body {
        display: flex;
        flex-direction: column;
      }

      #hamburger {
        position: absolute;
        top: 16px;
        left: 16px;
        font-size: 1.8em;
        background: none;
        border: none;
        color: #00ffcc;
        cursor: pointer;
        z-index: 1999;
      }

      #sidebar {
        position: fixed;
        top: 0;
        left: -250px;
        width: 250px;
        height: 100%;
        background-color: #161616;
        box-shadow: 3px 0 12px rgba(0, 255, 204, 0.2);
        padding: 25px 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: left 0.3s ease;
        z-index: 2000;
      }

      #sidebar.open {
        left: 0;
      }

      #sidebar h2 {
        color: #00ffcc;
        font-size: 1.4em;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #minimize-sidebar {
        font-size: 1em;
        cursor: pointer;
        background: none;
        color: #00ffcc;
        border: none;
      }

      #sidebar a {
        display: block;
        color: #e0e0e0;
        margin: 10px 0;
        text-decoration: none;
        font-size: 1em;
        transition: color 0.2s ease;
      }

      #sidebar a:hover {
        color: #00bfa6;
      }

      /* --- Control Deck Stylish Hover Animation --- */
      .control-link {
        transition: transform 0.3s ease, color 0.3s ease;
        position: relative;
      }

      .control-link::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        width: 0%;
        background-color: #00ffcc;
        transition: width 0.3s ease;
      }

      .control-link:hover {
        transform: scale(1.08) translateX(5px);
        color: #00ffee;
      }

      .control-link:hover::after {
        width: 100%;
      }

      .recent-chats {
        background-color: #222;
        padding: 10px;
        border-radius: 6px;
        font-size: 0.9em;
        overflow-y: auto;
        max-height: 100px;
      }
      .recent-chats-slider {
        display: flex;
        overflow-x: auto;
        overflow-y: hidden;
        gap: 12px;
        margin-top: 10px;
        padding-bottom: 6px;
        padding-right: 10px;
        scroll-behavior: smooth;
        scrollbar-width: thin;
      }

      .recent-chats-slider::-webkit-scrollbar {
        height: 6px;
      }

      .recent-chats-slider::-webkit-scrollbar-thumb {
        background-color: #00ffcc66;
        border-radius: 4px;
      }

      .recent-chats-slider::-webkit-scrollbar-track {
        background: transparent;
      }

      .recent-chats-slider .recent-card {
        width: 60px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
      }

      .recent-card img {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #00ffcc;
      }

      .recent-card span {
        font-size: 0.7em;
        margin-top: 6px;
        text-align: center;
        color: #00ffcc;
      }

      .logout {
        color: #ff4d4d;
        font-weight: bold;
        text-align: center;
        padding: 12px 0;
        border-top: 1px solid #333;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease,
          background-color 0.3s ease;
      }

      .logout:hover {
        transform: scale(1.15) rotate(1deg);
        background-color: #220000;
        color: #ff0000;
        text-shadow: 0 0 10px #ff0000, 0 0 20px #990000, 0 0 30px #660000;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 0 40px rgba(255, 0, 0, 0.5),
          inset 0 0 10px rgba(255, 0, 0, 0.3);
        animation: pulseFear 0.7s infinite alternate;
      }

      @keyframes pulseFear {
        0% {
          transform: scale(1.15) rotate(1deg);
          filter: brightness(1);
        }
        100% {
          transform: scale(1.18) rotate(-1deg);
          filter: brightness(1.4);
        }
      }

      .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 40px 16px 100px;
        transition: margin-left 0.3s ease;
      }

      .header-bar.sidebar-open {
        margin-left: 250px;
      }

      .header-text h1 {
        font-size: 1.6em;
        color: #00ffcc;
      }

      .header-icons {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .header-icons input[type="text"] {
        padding: 7px 12px;
        border-radius: 8px;
        border: 1px solid #00ffcc;
        background-color: #111;
        color: #00ffcc;
      }

      .header-icons img {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background-color: #1a1a1a;
        padding: 5px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
      }

      .header-icons img[alt="Discord"]:hover {
        box-shadow: 0 0 14px rgba(255, 255, 255, 0.7),
          0 0 30px rgba(0, 153, 255, 0.4);
        transform: scale(1.15) rotate(6deg);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .header-icons img[alt="Reddit"]:hover {
        box-shadow: 0 0 14px rgba(255, 69, 0, 0.7),
          0 0 30px rgba(255, 69, 0, 0.4);
        transform: scale(1.15) rotate(-6deg);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .main-content {
        padding: 30px 60px;
        transition: margin-left 0.3s ease;
        flex-grow: 1;
      }

      .main-content.sidebar-open {
        margin-left: 250px;
      }

      .btn-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
      }

      .btn {
        background-color: #1a1a1a;
        color: #00ffcc;
        border: 2px solid #00ffcc;
        padding: 15px 30px;
        border-radius: 12px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.35s ease-in-out;
      }

      .btn:hover {
        background-color: #00ffcc;
        color: #121212;
        box-shadow: 0 0 16px rgba(0, 255, 204, 0.6),
          0 0 30px rgba(0, 255, 204, 0.3);
        transform: scale(1.08) rotate(-1deg);
        transition: all 0.35s ease-in-out;
      }

      .character-section {
        margin-top: 40px;
      }

      .character-section h2 {
        font-size: 1.4em;
        margin-bottom: 20px;
        color: #00ffcc;
      }

      .slider-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      .arrow {
        font-size: 2em;
        color: #00ffcc;
        cursor: pointer;
        padding: 10px;
        user-select: none;
        z-index: 10;
        transition: transform 0.2s;
      }

      .arrow:hover {
        transform: scale(1.2);
      }

      .character-slider {
        display: flex;
        overflow-x: auto;
        scroll-behavior: smooth;
        gap: 16px;
        padding: 10px 0;
        scroll-snap-type: x mandatory;
      }

      .character-card {
        width: 260px;
        height: 340px;
        background: #1e1e1e;
        padding: 16px;
        border-radius: 14px;
        box-shadow: 0 0 8px rgba(0, 255, 204, 0.2);
        flex-shrink: 0;
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        flex-direction: column;
        scroll-snap-align: start;
      }

      .character-card:hover {
        transform: scale(1.05);
        box-shadow: 0 0 14px rgba(0, 255, 204, 0.4);
      }

      .character-image {
        width: 100%;
        height: 160px;
        background-color: #333;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .character-card h3 {
        font-size: 1.1em;
        margin-bottom: 6px;
        color: #00ffcc;
      }

      .character-card p {
        font-size: 0.9em;
        color: #ccc;
      }

      footer {
        background: #111;
        color: #777;
        padding: 30px 60px;
        font-size: 0.9em;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        transition: margin-left 0.3s ease;
      }

      footer.sidebar-open {
        margin-left: 250px;
      }

      footer a {
        color: #00ffcc;
        margin: 4px 0;
        display: inline-block;
        text-decoration: none;
      }

      .help-icon {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background-color: #00ffcc;
        color: #121212;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
      }

      .character-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }

      .action-menu {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: #121212;
        border: 1px solid #00ffcc;
        border-radius: 8px;
        padding: 6px 0;
        display: none;
        flex-direction: column;
        z-index: 10;
        min-width: 140px;
      }

      .action-menu button {
        background: none;
        border: none;
        padding: 8px 14px;
        text-align: left;
        color: #00ffcc;
        cursor: pointer;
        font-size: 0.9em;
      }

      .action-menu button:hover {
        background-color: #1a1a1a;
      }

      .menu-icon {
        position: absolute;
        bottom: 10px;
        right: 10px;
        font-size: 1.4em;
        color: #00ffcc;
        background: transparent;
        border: none;
        cursor: pointer;
        z-index: 5;
      }

      .username-tag {
        font-size: 0.75em;
        color: #888;
        margin-top: -4px;
        margin-bottom: 6px;
      }
      .search-container {
        position: relative;
      }

      .header-icons input[type="text"] {
        padding: 10px 14px;
        border-radius: 10px;
        border: 2px solid #00ffcc;
        background-color: #111;
        color: #00ffcc;
        font-size: 1em;
        width: 220px;
      }

      .search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background-color: #1a1a1a;
        border: 1px solid #00ffcc;
        border-radius: 6px;
        max-height: 160px;
        overflow-y: auto;
        z-index: 10;
        display: none;
      }

      .search-dropdown div {
        padding: 8px 12px;
        cursor: pointer;
        color: #e0e0e0;
      }

      .search-dropdown div:hover {
        background-color: #00ffcc;
        color: #121212;
      }
    </style>
  </head>
  <body>
    <button id="hamburger" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>

    <div id="sidebar">
      <div>
        <h2>
          Control Deck
          <button id="minimize-sidebar" onclick="toggleSidebar()">
            <i class="fas fa-angle-left"></i>
          </button>
        </h2>
        <a href="profile.html" class="control-link">🧑‍🚀 Profile</a>
        <a href="#" class="control-link">📜 The Codex</a>
        <a href="characters.html" class="control-link"
          ><i class="fas fa-masks-theater"></i> Characters</a
        >
        <a href="#">💬 Recent Chats</a>
        <div class="recent-chats-slider" id="recentChatsSlider">
          <!-- Character cards will appear here -->
        </div>
      </div>
      <div class="logout" onclick="alert('Logged out!')">🚪 Logout</div>
    </div>

    <div class="header-bar">
      <div class="header-text">
        <h1>✨ Welcome to TrendAI — Choose Your Story</h1>
        <p>
          Craft conversations, characters, and chaos. All powered by your
          imagination.
        </p>
      </div>
      <div class="header-icons">
        <div class="search-container">
          <input
            type="text"
            id="searchInput"
            placeholder="Search characters..."
            oninput="filterCharacters()"
          />
          <div id="searchResults" class="search-dropdown"></div>
        </div>
        <a href="https://discord.com/your-link" target="_blank">
          <img src="assets/icons/discord.webp" alt="Discord" />
        </a>
        <a href="https://reddit.com/your-link" target="_blank">
          <img src="assets/icons/reddit.webp" alt="Reddit" />
        </a>
      </div>
    </div>

    <div class="main-content">
      <div class="btn-container">
        <button class="btn" onclick="window.location.href='characters.html'">
          View Characters
        </button>
        <button
          class="btn"
          onclick="window.location.href='create-character.html'"
        >
          Create Character
        </button>
      </div>

      <div class="character-section">
        <h2>For You</h2>
        <div class="slider-wrapper">
          <span class="arrow" onclick="scrollSlider('left')">‹</span>
          <div class="character-slider" id="characterSlider">
            <!-- Cards will be inserted here -->
          </div>
          <span class="arrow" onclick="scrollSlider('right')">›</span>
        </div>
      </div>
    </div>

    <footer>
      <div>
        <a href="about.html">About</a> •
        <a href="characters.html">Characters</a> • <a href="#">Careers</a> •
        <a href="#">Safety Center</a>
      </div>
      <div>
        <a href="#">Blog</a> • <a href="#">Research</a> •
        <a href="cookie_policy.html">Cookie Policy</a> •
        <a href="privacy_policy.html">Privacy Policy</a> •
        <a href="terms_of_service.html">Terms of Service</a>
      </div>
    </footer>

    <script>
      // Codex modal logic
      // Find the "The Codex" link and attach click event
      (function () {
        // Polyfill for :contains selector
        function findCodexLink() {
          const links = document.querySelectorAll('a[href="#"]');
          for (const link of links) {
            if (link.textContent.includes("The Codex")) return link;
          }
          return null;
        }
        const codexLink = findCodexLink();
        if (codexLink) {
          codexLink.addEventListener("click", function (e) {
            e.preventDefault();
            // Close sidebar if open before opening Codex
            const sidebar = document.getElementById("sidebar");
            if (sidebar && sidebar.classList.contains("open")) {
              toggleSidebar();
            }
            document.getElementById("codexOverlay").style.display = "block";
            document.getElementById("codexPopup").style.display = "flex";
            document.getElementById("codexPopup").classList.add("show");
            showCodexSection("account");
          });
        }
      })();

      document.addEventListener("DOMContentLoaded", function () {
        var overlay = document.getElementById("codexOverlay");
        if (overlay) {
          overlay.addEventListener("click", closeCodex);
        }
      });

      function closeCodex() {
        document.getElementById("codexOverlay").style.display = "none";
        document.getElementById("codexPopup").style.display = "none";
        document.getElementById("codexPopup").classList.remove("show");
      }

      function showCodexSection(section) {
        const content = document.getElementById("codexContent");
        if (!content) return;
        if (section === "account") {
          content.innerHTML = `
            <p>Status: <strong>Free</strong> <button style="margin-left: 10px;">Upgrade</button></p>
            <div style="margin-top: 16px;">
              <button style="margin-right: 10px;">Switch Account</button>
              <button>Delete Account</button>
            </div>
          `;
        } else if (section === "preferences") {
          content.innerHTML = `
            <div class="preference-group">
              <label for="language">Language:</label>
              <select id="language">
                <option>English</option>
                <option>French</option>
                <option>Spanish</option>
                <option>Hindi</option>
              </select>
            </div>
            <div class="preference-group theme-options">
              <label>Theme:</label>
              <label><input type="radio" name="theme" checked> Dark</label>
              <label><input type="radio" name="theme"> Light</label>
            </div>
          `;
        } else if (section === "friends") {
          content.innerHTML = `
            <p>No friends to show. This is where your friends will appear!</p>
            <div style="margin-top: 16px;">
              <button style="margin-right: 10px;">Invite Friends</button>
              <button>Accept Requests</button>
            </div>
          `;
        }
      }
      const charactersData = [];

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const main = document.querySelector(".main-content");
        const header = document.querySelector(".header-bar");
        const footer = document.querySelector("footer");
        sidebar.classList.toggle("open");
        main.classList.toggle("sidebar-open");
        header.classList.toggle("sidebar-open");
        footer.classList.toggle("sidebar-open");
      }

      function scrollSlider(dir) {
        const slider = document.getElementById("characterSlider");
        slider.scrollBy({
          left: dir === "left" ? -300 : 300,
          behavior: "smooth",
        });
      }

      function toggleMenu(event, index) {
        event.stopPropagation();
        const menu = document.getElementById(`menu-${index}`);
        const allMenus = document.querySelectorAll(".action-menu");
        allMenus.forEach((m) => (m.style.display = "none"));
        menu.style.display = "flex";
      }

      function editCharacter(index) {
        const characters = JSON.parse(localStorage.getItem("characters")) || [];
        const character = characters[index];
        const nameParam = encodeURIComponent(character.name);
        const redirectURL = `create-character.html?name=${nameParam}&from=login.html`;
        window.location.href = redirectURL;
      }
      function confirmDelete(index) {
        if (confirm("Are you sure you want to delete this character?")) {
          const characters =
            JSON.parse(localStorage.getItem("characters")) || [];
          const characterToDelete = characters[index];
          characters.splice(index, 1);
          localStorage.setItem("characters", JSON.stringify(characters));

          // Remove from recentCharacters if present
          let recent =
            JSON.parse(localStorage.getItem("recentCharacters")) || [];
          recent = recent.filter((name) => name !== characterToDelete.name);
          localStorage.setItem("recentCharacters", JSON.stringify(recent));

          location.reload();
        }
      }

      function removeCard(button) {
        const card = button.closest(".character-card");
        card.remove();
      }

      function loadCharacters() {
        const slider = document.getElementById("characterSlider");
        const stored = localStorage.getItem("characters");
        let characters = [];
        try {
          characters = JSON.parse(stored) || [];
        } catch (e) {}

        charactersData.length = 0;
        charactersData.push(...characters);

        characters.forEach((c, i) => {
          const card = document.createElement("div");
          card.className = "character-card";
          card.style.position = "relative";

          card.innerHTML = `
          <div class="character-image">
            ${c.image ? `<img src="${c.image}" alt="${c.name}">` : ""}
          </div>
          <h3>${c.name}</h3>
          <div class="username-tag">by @${
            getStoredUsername() || "unknown"
          }</div>
          <p>"${c.tagline}"</p>
          <button class="menu-icon" onclick="toggleMenu(event, ${i})">\u22EF</button>
          <div class="action-menu" id="menu-${i}">
            <button onclick="editCharacter(${i})">✏️ Character</button>
            <button onclick="confirmDelete(${i})">🗑️ Delete</button>
            <button onclick="removeCard(this)">❌ Remove</button>
          </div>
        `;

          card.onclick = function (e) {
            if (
              !e.target.classList.contains("menu-icon") &&
              !e.target.closest(".action-menu")
            ) {
              localStorage.setItem("roleplayCharacter", c.name);
              window.location.href = "roleplay.html";
            }
          };

          slider.appendChild(card);
        });
      }

      function getStoredUsername() {
        try {
          const profile = JSON.parse(localStorage.getItem("userProfile"));
          return profile?.username || null;
        } catch {
          return null;
        }
      }

      function filterCharacters() {
        const query = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        const resultsContainer = document.getElementById("searchResults");
        resultsContainer.innerHTML = "";

        if (!query) {
          resultsContainer.style.display = "none";
          return;
        }

        const filtered = charactersData.filter((c) => {
          const nameMatch = c.name.toLowerCase().includes(query);
          const tagsMatch =
            Array.isArray(c.tags) &&
            c.tags.some((tag) => tag.toLowerCase().includes(query));
          return nameMatch || tagsMatch;
        });

        if (filtered.length) {
          filtered.forEach((c) => {
            const result = document.createElement("div");
            result.style.display = "flex";
            result.style.alignItems = "center";
            result.style.gap = "12px";

            const avatar = document.createElement("img");
            avatar.src = c.image || "assets/placeholder-avatar.png"; // fallback image
            avatar.alt = c.name;
            avatar.style.width = "36px";
            avatar.style.height = "36px";
            avatar.style.borderRadius = "50%";
            avatar.style.objectFit = "cover";

            const name = document.createElement("span");
            name.textContent = c.name;

            result.appendChild(avatar);
            result.appendChild(name);

            result.onclick = () => {
              localStorage.setItem("roleplayCharacter", c.name);
              window.location.href = "roleplay.html";
            };

            resultsContainer.appendChild(result);
          });

          resultsContainer.style.display = "block";
        } else {
          resultsContainer.innerHTML = "<div>No results found</div>";
          resultsContainer.style.display = "block";
        }
      }

      function scrollToCharacter(name) {
        const cards = document.querySelectorAll(".character-card");
        for (let card of cards) {
          if (card.querySelector("h3").textContent === name) {
            card.scrollIntoView({ behavior: "smooth", inline: "start" });
            break;
          }
        }
        document.getElementById("searchResults").style.display = "none";
      }

      document.addEventListener("click", function (event) {
        const sidebar = document.getElementById("sidebar");
        const isSidebarOpen = sidebar?.classList.contains("open");
        if (
          isSidebarOpen &&
          !sidebar.contains(event.target) &&
          !event.target.closest("#hamburger")
        ) {
          toggleSidebar();
        }

        document.querySelectorAll(".action-menu").forEach((menu) => {
          if (
            !menu.contains(event.target) &&
            !event.target.classList.contains("menu-icon")
          ) {
            menu.style.display = "none";
          }
        });

        // Close search results when clicking outside
        const searchContainer = document.querySelector(".search-container");
        const searchResults = document.getElementById("searchResults");
        if (searchResults && !searchContainer.contains(event.target)) {
          searchResults.style.display = "none";
        }
      });

      window.onload = loadCharacters;
      function loadRecentChats() {
        const container = document.getElementById("recentChatsSlider");
        if (!container) return;

        container.innerHTML = "";
        const recentCharacters =
          JSON.parse(localStorage.getItem("recentCharacters")) || [];
        const allCharacters =
          JSON.parse(localStorage.getItem("characters")) || [];

        recentCharacters
          .slice()
          .reverse()
          .forEach((name) => {
            const c = allCharacters.find((char) => char.name === name);
            if (!c) return;

            const card = document.createElement("div");
            card.className = "recent-card";
            card.onclick = () => {
              let recent =
                JSON.parse(localStorage.getItem("recentCharacters")) || [];
              const existingIndex = recent.indexOf(c.name);
              if (existingIndex !== -1) recent.splice(existingIndex, 1);
              recent.push(c.name); // Most recently clicked goes to end
              localStorage.setItem("recentCharacters", JSON.stringify(recent));
              localStorage.setItem("roleplayCharacter", c.name);
              window.location.href = "roleplay.html";
            };

            card.innerHTML = `
            <img src="${c.image || "assets/placeholder-avatar.png"}" alt="${
              c.name
            }">
            <span>${c.name}</span>
          `;
            container.appendChild(card);
          });
      }

      window.onload = () => {
        loadCharacters();
        loadRecentChats();
      };
      localStorage.removeItem("editCharacterIndex");
    </script>
    <div class="codex-overlay" id="codexOverlay" style="display: none"></div>
    <div class="codex-popup" id="codexPopup" style="display: none">
      <div class="codex-left">
        <button onclick="showCodexSection('account')">Account</button>
        <button onclick="showCodexSection('preferences')">Preferences</button>
        <button onclick="showCodexSection('friends')">Friends</button>
      </div>
      <div class="codex-right" id="codexContent"></div>
      <span class="codex-close" onclick="closeCodex()">✖</span>
    </div>
  </body>
</html>
