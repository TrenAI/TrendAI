<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Create Character - TrendAI</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Orbitron", sans-serif;
        background-color: #0b0b0b;
        color: #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: start;
        min-height: 100vh;
        padding: 40px 20px;
      }

      .form-container {
        background-color: #161616;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 0 16px rgba(0, 255, 204, 0.4);
        width: 100%;
        max-width: 900px;
        position: relative;
        display: flex;
        flex-direction: row;
        gap: 30px;
      }

      .left-panel {
        flex: 1;
      }

      .right-panel {
        width: 220px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .avatar-wrapper {
        position: relative;
        width: 160px;
        height: 160px;
        border-radius: 8px;
        background-color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .avatar-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .edit-icon {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background-color: #00ffcc;
        color: #121212;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 0 8px rgba(0, 255, 204, 0.5);
      }

      h2 {
        color: #00ffcc;
        margin-bottom: 20px;
        text-align: center;
      }

      label {
        font-size: 0.95em;
        margin-top: 18px;
        display: block;
        color: #00ffcc;
      }

      input[type="text"],
      textarea {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        background-color: #1e1e1e;
        border: 1px solid #00ffcc;
        color: #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        resize: vertical;
      }

      .tag-dropdown {
        background: #1a1a1a;
        border: 1px solid #00ffcc;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        overflow-x: auto;
        max-height: 100px;
        overflow-y: auto;
      }

      .tag-option {
        background-color: #00ffcc;
        color: #121212;
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 0.85em;
        cursor: pointer;
        white-space: nowrap;
      }

      .selected-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .selected-tag {
        background-color: #1e1e1e;
        border: 1px solid #00ffcc;
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 0.85em;
        display: flex;
        align-items: center;
      }

      .selected-tag span {
        margin-left: 8px;
        color: #ff4d4d;
        cursor: pointer;
      }

      .submit-btn {
        position: absolute;
        right: 30px;
        bottom: 30px;
        background-color: #00ffcc;
        color: #121212;
        padding: 14px 28px;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1em;
        box-shadow: 0 0 10px rgba(0, 255, 204, 0.4);
      }

      .submit-btn:hover {
        background-color: #00e6b8;
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <div class="left-panel">
        <h2 id="formTitle">Create New Character</h2>

        <label for="name">Character Name</label>
        <input
          type="text"
          id="name"
          maxlength="20"
          placeholder="Max 20 characters..."
        />

        <label for="tagline">Tagline</label>
        <input
          type="text"
          id="tagline"
          maxlength="50"
          placeholder="Max 50 characters..."
        />

        <label for="description">Description</label>
        <textarea
          id="description"
          maxlength="500"
          rows="4"
          placeholder="Max 500 characters..."
        ></textarea>

        <label for="greeting">Greeting Message</label>
        <textarea
          id="greeting"
          maxlength="4500"
          rows="6"
          placeholder="What the character will say to start..."
        ></textarea>

        <label for="tags">Choose Tags</label>
        <div class="tag-dropdown" id="tagDropdown"></div>
        <div class="selected-tags" id="selectedTags"></div>
      </div>

      <div class="right-panel">
        <div class="avatar-wrapper" id="avatarWrapper">
          <img id="avatarImage" src="" alt="Avatar" style="display: none" />
          <div
            class="edit-icon"
            onclick="document.getElementById('avatarInput').click()"
          >
            ✎
          </div>
          <input
            type="file"
            id="avatarInput"
            accept="image/*"
            style="display: none"
            onchange="handleImageUpload(event)"
          />
        </div>
      </div>

      <button class="submit-btn" id="submitBtn" onclick="saveCharacter()">
        Create Character
      </button>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
const nameFromURL = urlParams.get("name");
const fromPage = urlParams.get("from");

if (fromPage) {
  localStorage.setItem("redirectAfterEdit", fromPage);
}

if (nameFromURL) {
  const existingCharacters =
    JSON.parse(localStorage.getItem("characters")) || [];
  const index = existingCharacters.findIndex(
    (c) => c.name === nameFromURL
  );
  if (index !== -1) {
    localStorage.setItem("editCharacterIndex", index);
  }
}
      const tagOptions = [
        "anime",
        "action",
        "adventure",
        "fantasy",
        "romance",
        "shy",
        "girlfriend",
        "slice of life",
        "wife",
        "schoollife",
        "jealous",
        "K-pop",
        "mentor",
        "cyberpunk",
        "detective",
        "villain",
        "dreamy",
        "energetic",
        "mysterious",
        "nerdy",
        "hero",
        "villager",
        "mystic",
        "scientist",
        "time traveler",
        "alien",
        "robot",
        "healer",
        "outlaw",
        "spy"
      ];

      const tagDropdown = document.getElementById("tagDropdown");
      const selectedTagsContainer = document.getElementById("selectedTags");
      let selectedTags = [];
      let characters = JSON.parse(localStorage.getItem("characters")) || [];

      tagOptions.forEach((tag) => {
        const tagEl = document.createElement("div");
        tagEl.className = "tag-option";
        tagEl.textContent = `+ ${tag}`;
        tagEl.onclick = () => {
          if (!selectedTags.includes(tag)) {
            selectedTags.push(tag);
            renderSelectedTags();
            tagEl.style.display = "none"; // Hide tag from dropdown
          }
        };
        tagDropdown.appendChild(tagEl);
      });

      function renderSelectedTags() {
        selectedTagsContainer.innerHTML = "";
        selectedTags.forEach((tag) => {
          const tagEl = document.createElement("div");
          tagEl.className = "selected-tag";
          
          // Safely create text content to prevent XSS
          const tagText = document.createTextNode(tag);
          const removeSpan = document.createElement("span");
          removeSpan.textContent = "×";
          removeSpan.style.cursor = "pointer";
          removeSpan.onclick = () => removeTag(tag);
          
          tagEl.appendChild(tagText);
          tagEl.appendChild(removeSpan);
          selectedTagsContainer.appendChild(tagEl);
        });
      }

      function removeTag(tag) {
        selectedTags = selectedTags.filter((t) => t !== tag);
        renderSelectedTags();
        const dropdownTags = tagDropdown.querySelectorAll(".tag-option");
        dropdownTags.forEach((el) => {
          if (el.textContent === `+ ${tag}`) {
            el.style.display = "inline-block"; // Show the tag again
          }
        });
      }

      function handleImageUpload(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.getElementById("avatarImage");
          img.src = e.target.result;
          img.style.display = "block";
        };
        reader.readAsDataURL(file);
      }

      function saveCharacter() {
        const name = document.getElementById("name").value.trim();
        const tagline = document.getElementById("tagline").value.trim();
        const description = document.getElementById("description").value.trim();
        const greeting = document.getElementById("greeting").value.trim();
        const avatarImg = document.getElementById("avatarImage").src || null;
        let profile;
        try {
          profile = JSON.parse(localStorage.getItem("userProfile")) || {};
        } catch (e) {
          console.warn("Failed to parse userProfile from localStorage, using empty object:", e);
          profile = {};
        }
        const username = profile.username || "unknown";

        if (!name || !tagline || !description || !greeting) {
          alert("Please fill in all fields.");
          return;
        }

        const character = {
          name,
          tagline,
          description,
          greeting,
          tags: selectedTags,
          image: avatarImg,
          username,
        };

        const editIndex = localStorage.getItem("editCharacterIndex");

        if (editIndex !== null) {
          characters[editIndex] = character;
          localStorage.removeItem("editCharacterIndex");
          alert("Character updated!");
        } else {
          characters.push(character);
          alert("Character saved!");
        }

       localStorage.setItem("characters", JSON.stringify(characters));
localStorage.setItem("roleplayCharacter", name);  // ✅ Set the character key for roleplay
const redirectURL =
  localStorage.getItem("redirectAfterEdit") || "login.html";
localStorage.removeItem("redirectAfterEdit");
window.location.href = redirectURL;
      }

      // Load existing data if in edit mode
      window.onload = () => {
        const editIndex = localStorage.getItem("editCharacterIndex");
        if (editIndex !== null) {
          const c = characters[editIndex];
          document.getElementById("name").value = c.name;
          document.getElementById("tagline").value = c.tagline;
          document.getElementById("description").value = c.description;
          document.getElementById("greeting").value = c.greeting;
          selectedTags = c.tags || [];
          renderSelectedTags();

          if (c.image) {
            const img = document.getElementById("avatarImage");
            img.src = c.image;
            img.style.display = "block";
          }

          document.getElementById("formTitle").textContent = "Edit Character";
          document.getElementById("submitBtn").textContent = "Update Character";
        }
      };

      window.addEventListener("beforeunload", () => {
        localStorage.removeItem("editCharacterIndex");
      });
    </script>
  </body>
</html>
